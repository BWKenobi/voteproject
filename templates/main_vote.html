{% load objects_extras %}
{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Голосование зрителей</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" href="{% static 'img/logo.png' %}" sizes="180x180">
  <link rel="icon" href="{% static 'img/logo.png' %}" sizes="32x32" type="image/png">
  <link rel="icon" href="{% static 'img/logo.png' %}" sizes="16x16" type="image/png">

  <link rel="stylesheet" type="text/css" href="{% static 'css/concerted.css' %}">
  <script src="{% static 'js/qrcode.min.js' %}"></script>
</head>
<body>

<div class="overlay"></div>

<div class="wrapper">

  <!-- HEADER -->
  <div class="header" data-token="{{ theme_token }}">
    <div class="title">Голосуем за лучший номер!</div>
  </div>

  <!-- LIST -->
  <div class="content">
    <div class="column" id="left"></div>
    <div class="column" id="right"></div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="timer-block" style="margin-left: 100px">
      <div class="timer" id="timer"></div>
      <div class="timer-label">до окончания голосования</div>
    </div>

    

    <div class="timer-block" style="margin-right: 100px; text-align: right;">
      <div class="timer" id="timer_2"></div>
      <div class="timer-label">до окончания голосования</div>
    </div>

    <div class="qr-block qr-hide">
      <!-- <div class="qr-text">
        Наведите камеру<br>
        для голосования
      </div> -->
      <div class="qr" id="qrcode"></div>
    </div>
  </div>

</div>

<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>


<script>
  const items = [
    {% for vote_part in vote_parts %}
    "<div class='text'><span class='number'>{{ vote_part.number}}.</span> {{ vote_part.name }} - <span class='ansamble'>{{ vote_part.sub_name }}</span></div><div class='votes' id='v{{ forloop.counter }}' data-pk='{{ vote_part.pk }}'>{{ vote_counts|lookup:vote_part.pk }}</div>",
    {% endfor %}
  ];

  // const votes = Array(items.length).fill(0);
  const left = document.getElementById("left");
  const right = document.getElementById("right");

  const half = Math.ceil(items.length / 2);

  const cards = [];
  const votes = {};

// items.forEach((text, i) => {
//   const div = document.createElement("div");
//   div.className = "item";
//   div.dataset.index = i;
//   div.innerHTML = text;
//   cards.push(div);
// });

items.forEach((text, i) => {
  const div = document.createElement("div");
  div.className = "item";
  div.dataset.index = i;

  // достаём pk из вложенного .votes
  const tmp = document.createElement("div");
  tmp.innerHTML = text;
  const pk = tmp.querySelector('.votes').dataset.pk;

  div.dataset.pk = pk;
  div.innerHTML = text;

  cards.push(div);
});


// $('.item').each(function(){
//   $('this').attr('data-index', $(this).find('.votes').attr('id').slice(1));
// });
renderColumns();

function renderColumns() {
  // очистка колонок
  left.innerHTML = "";
  right.innerHTML = "";

  // сортировка по голосам (по убыванию)
  // cards.sort((a, b) => {
  //   return votes[b.dataset.index] - votes[a.dataset.index];
  // });

  cards.sort((a, b) => {
  return (votes[b.dataset.pk] || 0) - (votes[a.dataset.pk] || 0);
});

  const half = Math.ceil(cards.length / 2);

  cards.forEach((card, i) => {
    if (i < half) {
      left.appendChild(card);
    } else {
      right.appendChild(card);
    }
  });
}

  // DEMO-голоса
  // setInterval(() => {
  //   const i = Math.floor(Math.random() * votes.length);
  //   votes[i]++;
  //   document.getElementById("v" + i).textContent = votes[i];

  //   renderColumns();
  // }, 1300);

  // TIMER
  let seconds = 5 * 60;
  const timerEl = document.getElementById("timer");
  const timerEl_2 = document.getElementById("timer_2");

  setInterval(() => {
    m = String(Math.floor(seconds / 60)).padStart(2, "0");
    s = String(seconds % 60).padStart(2, "0");

    $.ajax({
      url: "{% url 'ajax_get_data' %}",
      success: function(data){
        data = $.parseJSON(data);

        if (data['theme_token'] != $('.header').attr('data-token'))
          document.location.reload();

        m = String(Math.floor(data['seconds'] / 60)).padStart(2, "0");
        s = String(data['seconds'] % 60).padStart(2, "0");

        timerEl.textContent = `${m}:${s}`;
        timerEl_2.textContent = `${m}:${s}`;

        if (data['active'])
          $('.qr-block').removeClass('qr-hide');
        else
          $('.qr-block').addClass('qr-hide');

        if (data['zoom'])
          $('.qr-block #qrcode img').addClass('qr-scale');
        else
          $('.qr-block #qrcode img').removeClass('qr-scale');

        
        // for (const [key, value] of Object.entries(data['vote_counts'])) {
        //   $('.votes[data-pk=' + key + ']').text(value);
        // }

        for (const [key, value] of Object.entries(data['vote_counts'])) {
  votes[key] = value;
  $('.votes[data-pk=' + key + ']').text(value);
}

        renderColumns();
      }
    });
  }, 1000);

  // QR
  new QRCode(document.getElementById("qrcode"), {
    text: "{{ url }}",
    width: 800,
    height: 800
  });

  $('#qrcode img').click(function(){
    if ($(this).hasClass('qr-scale'))
      $(this).removeClass('qr-scale');
    else
      $(this).addClass('qr-scale');

  });
</script>

</body>
</html>